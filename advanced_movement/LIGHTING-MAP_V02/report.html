<!DOCTYPE html>
<html>
<head>
  <title>Segnala guasto</title>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="./assets/logos/faviconWhite.png" type="image/png" media="(prefers-color-scheme: dark)">
  <link rel="icon" href="./assets/logos/faviconBlack.png" type="image/png" media="(prefers-color-scheme: light)">
</head>
<body>
  <link rel="stylesheet" href="./assets/styles/base.css">
  <link rel="stylesheet" href="./assets/styles/style_index.css">
  <link rel="stylesheet" href="./assets/styles/style_reports.css">
  
  <div id="divFormContainer">
    <form id="reportForm">
      <h2>Segnala punto luce</h2>
      <label id="lblPlId">Numero Palo: </label>
      <label id="lblPlAdr">Indirizzo: </label>
      <label for="slctTypeReport">Seleziona il tipo di segnalazione:</label>
      <select id="slctTypeReport" class="base-select">
        <option value="LIGHT_POINT_OFF">Punto luce spento</option>
        <option value="PLANT_OFF">Impianto spento</option>
        <option value="DAMAGED_COMPLEX">Complesso danneggiato</option>
        <option value="DAMAGED_SUPPORT">Morsettiera rotta</option>
        <option value="BROKEN_TERMINAL_BLOCK">Sostegno danneggiato</option>
        <option value="BROKEN_PANEL">Quadro danneggiato</option>
        <option value="OTHER">Altro</option>
      </select>
      <br>
      <label for="txtDesc">Note: </label>
      <textarea rows="5" cols="60" id="txtDesc" placeholder="Inserisci note sulla segnalazione" class="base-textarea"></textarea>
      <br>
      <button type="submit" id="btnSend" class="base-btn">Invia segnalazione</button>
    </form>

  </div>

  <script>
  const BASE_URL = 'https://lighting-map.glitch.me'; 
  const divFormContainer = document.getElementById("divFormContainer");
  const reportForm = document.getElementById('reportForm')
  const slctTypeReport = document.getElementById('slctTypeReport')
  const txtDesc = document.getElementById('txtDesc')
  const loading = document.getElementById('loading');
  const lblPlId = document.getElementById('lblPlId');
  const lblPlAdr = document.getElementById('lblPlAdr');
  const userData = JSON.parse(localStorage.getItem('userData'));
  let address = ""

const translation_report_type = {
    "LIGHT_POINT_OFF": "Punto luce spento",
    "PLANT_OFF": "Impianto spento",
    "DAMAGED_COMPLEX": "Complesso danneggiato",
    "DAMAGED_SUPPORT": "Morsettiera rotta",
    "BROKEN_TERMINAL_BLOCK": "Sostegno danneggiato",
    "BROKEN_PANEL": "Quadro danneggiato",
    "OTHER": "Altro",
    "MADE_SAFE_BUT_SYSTEM_NEEDS_RESTORING": "Messa in sicurezza ma da ripristinare impianto",
    "FAULT_ELIMINATED_AND_SYSTEM_RESTORED": "Guasto eliminato e impianto ripristinato"
}  

function translateString(englishString) {
    return translation_report_type[englishString] || englishString;
  }
function getQueryParams() {
  let params = {};
  let queryString = window.location.search.substring(1);
  let queries = queryString.split("&");
  for (let i = 0; i < queries.length; i++) {
    let pair = queries[i].split("=");
    params[pair[0]] = decodeURIComponent(pair[1]);
  }
  return params;
}

    // Recuperare i parametri dall'URL
    let params = getQueryParams();
    document.title = `Segnala guasto PL ${params.numeroPalo}`;

    // Aggiungi un event listener al form
    reportForm.addEventListener('submit', async (e)=> {
      e.preventDefault(); 

      const formData = {
        report_type: slctTypeReport.value,
        description: txtDesc.value,
        name: params.comune,
        numero_palo: params.numeroPalo,
        date: new Date()
      };


      clearAllChildren(divFormContainer);
      createLoader()
      

      try {
        const response = await fetch(`${BASE_URL}/addReport`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          throw new Error(`Operazione non riuscita, controlla che i dati siano corretti`);
        }

        const result = await response.text();

        const result2 = await sendMailOfReport();
        if (!result2) console.warn('email non inviata')
        clearAllChildren(divFormContainer);
        createCard(result);
      } catch (error) {
        console.error('Errore durante la comunicazione con il server:', error);
        clearAllChildren(divFormContainer);
        createCard('Errore durante la comunicazione con il server', false); 
      }
    });

function clearAllChildren(elem) {
  while (elem.firstChild) {
    elem.removeChild(elem.firstChild);
  }
}

function createLoader() {
      const loader = document.createElement('div');
      loader.className = 'loader';

      for (let i = 0; i < 3; i++) {
        const circle = document.createElement('div');
        circle.className = 'circle';
        loader.appendChild(circle);
      }

      const square = document.createElement('div');
      square.className = 'square';
      loader.appendChild(square);

      divFormContainer.appendChild(loader);
    }


async function sendMailOfReport(){
  let date = new Date();
  let dateISO = date.toISOString();

  const type = translateString(slctTypeReport.value);

  const formData = {
    name: params.comune,
    user:{
        name: userData.name,
        surname: userData.surname,
        email: userData.email,
        cell: !userData.cell ? "" : userData.cell
    },
    date: dateISO,
    light_point:{
        numero_palo: params.numeroPalo,
        indirizzo: address
    },
    report: {
        report_type: type,
        description: txtDesc.value
    }

}


  try {
        const response = await fetch(`${BASE_URL}/send-email-to-user/lightPointReported`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const result = await response.text();
        if (result.ok) return true;
        return false;

  } catch (e){
    console.error(e)
    return false;
  }
}

function createCard(msgText, isSuccess  = true) {
      const divFormContainer = document.getElementById('divFormContainer');

      const card = document.createElement('div');
      card.id = 'card';
      card.className = 'animated fadeIn';

      const upperSide = document.createElement('div');
      upperSide.id = 'upper-side';

      let svg, status;
      if (isSuccess) {
        upperSide.style.backgroundColor = '#57A773';
        svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('version', '1.1');
        svg.setAttribute('id', 'checkmark');
        svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
        svg.setAttribute('xmlns:xlink', 'http://www.w3.org/1999/xlink');
        svg.setAttribute('x', '0px');
        svg.setAttribute('y', '0px');
        svg.setAttribute('xml:space', 'preserve');

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M131.583,92.152l-0.026-0.041c-0.713-1.118-2.197-1.447-3.316-0.734l-31.782,20.257l-4.74-12.65 c-0.483-1.29-1.882-1.958-3.124-1.493l-0.045,0.017c-1.242,0.465-1.857,1.888-1.374,3.178l5.763,15.382 c0.131,0.351,0.334,0.65,0.579,0.898c0.028,0.029,0.06,0.052,0.089,0.08c0.08,0.073,0.159,0.147,0.246,0.209 c0.071,0.051,0.147,0.091,0.222,0.133c0.058,0.033,0.115,0.069,0.175,0.097c0.081,0.037,0.165,0.063,0.249,0.091 c0.065,0.022,0.128,0.047,0.195,0.063c0.079,0.019,0.159,0.026,0.239,0.037c0.074,0.01,0.147,0.024,0.221,0.027 c0.097,0.004,0.194-0.006,0.292-0.014c0.055-0.005,0.109-0.003,0.163-0.012c0.323-0.048,0.641-0.16,0.933-0.346l34.305-21.865 C131.967,94.755,132.296,93.271,131.583,92.152z');
        svg.appendChild(path);

        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('fill', 'none');
        circle.setAttribute('stroke', '#ffffff');
        circle.setAttribute('stroke-width', '5');
        circle.setAttribute('stroke-miterlimit', '10');
        circle.setAttribute('cx', '109.486');
        circle.setAttribute('cy', '104.353');
        circle.setAttribute('r', '32.53');
        svg.appendChild(circle);

        status = document.createElement('h3');
        status.id = 'status';
        status.textContent = 'Successo';
      }else{
        upperSide.style.backgroundColor = '#D75A4A';
        const svgNS = "http://www.w3.org/2000/svg";
        svg = document.createElementNS(svgNS, 'svg');
        svg.setAttribute('version', '1.1');
        svg.setAttribute('id', 'error-icon');
        svg.setAttribute('viewBox', '0 0 50 50');
        svg.setAttribute('xml:space', 'preserve');

        const circle = document.createElementNS(svgNS, 'circle');
        circle.setAttribute('style', 'fill:#D75A4A;');
        circle.setAttribute('cx', '25');
        circle.setAttribute('cy', '25');
        circle.setAttribute('r', '25');
        svg.appendChild(circle);

        const polyline1 = document.createElementNS(svgNS, 'polyline');
        polyline1.setAttribute('style', 'fill:none;stroke:#FFFFFF;stroke-width:2;stroke-linecap:round;stroke-miterlimit:10;');
        polyline1.setAttribute('points', '16,34 25,25 34,16');
        svg.appendChild(polyline1);

        const polyline2 = document.createElementNS(svgNS, 'polyline');
        polyline2.setAttribute('style', 'fill:none;stroke:#FFFFFF;stroke-width:2;stroke-linecap:round;stroke-miterlimit:10;');
        polyline2.setAttribute('points', '16,16 25,25 34,34');
        svg.appendChild(polyline2);

        status = document.createElement('h3');
        status.id = 'status';
        status.textContent = 'Errore';

      }
      

      upperSide.appendChild(svg);
      upperSide.appendChild(status);

      const lowerSide = document.createElement('div');
      lowerSide.id = 'lower-side';

      const message = document.createElement('p');
      message.id = 'message';
      message.textContent = msgText;
      if(!isSuccess){
        const ripBtn = document.createElement('a');
        ripBtn.id = 'ripBtn';
        ripBtn.textContent = 'Riprova';
        ripBtn.href = "#"; 
        ripBtn.onclick = () => window.location.reload(); 
        lowerSide.appendChild(ripBtn);
      }
      const contBtn = document.createElement('a');
      contBtn.href = 'resource.html';
      contBtn.id = 'contBtn';
      contBtn.textContent = 'Torna alla home';

      lowerSide.appendChild(message);
      lowerSide.appendChild(contBtn);

      card.appendChild(upperSide);
      card.appendChild(lowerSide);

      divFormContainer.appendChild(card);
    }

    async function findAddress(lat, lng) {
    lat = parseFloat(lat);
    lng = parseFloat(lng);
    const response = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=AIzaSyD1Ch3HNv8Mq0S4zztoCea_kzW_VQvPKVg`);
    const data = await response.json();
    const route = data.results.filter(result => result.types.includes('route'));
    return route.length > 0 ? route[0].formatted_address : "Indirizzo non trovato";
}

findAddress(params.lat, params.lng)
  .then(addressLocal => {
      const address = addressLocal;
      lblPlAdr.textContent = `Indirizzo: ${address}`;
  })
  .catch(error => {
      console.error('Errore nel recuperare l\'indirizzo:', error);
      lblPlAdr.textContent = "Errore nel recuperare l'indirizzo.";
  });

  lblPlId.textContent = `Punto luce n°: ${params.numeroPalo}`
  </script>
</body>
</html>
